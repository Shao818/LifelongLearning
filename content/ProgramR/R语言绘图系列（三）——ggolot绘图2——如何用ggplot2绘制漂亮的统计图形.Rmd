---
author:
  - 水滴
title: 'R语言绘图系列（三）：ggolot绘图2：图例、背景与网格线'
date: 2021-06-09
categories:
  - R
  - 绘图
  - ggplot
  - 坐标轴
tags:
  - R
  - 绘图
  - ggplot
  - 坐标轴
slug: ggolot_2
weight: 0004
description: 本期内容将会介绍 ggplot2 绘图语法的基础，以及如何调整图形坐标轴的内容和外观、修改图形标题等内容。
--- 

<font face="思源宋体 CN" >

![](https://gitee.com/shao818/Figure/raw/master/20210609212856.png)  


> R语言绘图系列（三）：ggolot绘图1：基本介绍、坐标轴与标题。

# 图例  

## 添加图例  

当数据中包含分组变量，并按照分组变量绘制图形时，通常都需要添加一个图例来标识分组数据。本例数据中，我们将根据 season 变量给图像上色，用 ggplot 的方式来表达就是：我们将变量 season 映射到 color 美学。  


关于将变量映射到美学的一点解释：  


Aesthetics 美学   

美学描述了给定图形元素的各个方面，如位置、形状、大小、颜色、线条等：    

![Aesthetics 美学](https://gitee.com/shao818/Figure/raw/master/20210609213002.png)  

除了上图所示的例子之外，还可能在数据可视化中遇到许多其他的美学问题。例如，如果我们想要显示文本，我们可能必须指定字体类型，字体名称，字体大小等，如果图形对象重叠，我们可能必须指定它们是否部分透明等。所有的美学都可以分为两类：一类可以表示连续数据，另一类不能。在上图的例子中，位置、大小、颜色和线条宽度可以表示连续的数据，而形状和线类型通常只能表示离散数据。  


- Scale 尺度  

要将数据值映射到美学上，我们需要指定哪些数据值对应于哪些特定的美学值。例如，如果我们的图形有一个 x 轴，那么我们需要指定哪些数据值落在沿这个轴的特定位置上。类似地，我们可能需要指定哪些数据值由特定的形状或颜色表示。数据值和美学值之间的映射是通过尺度 scale 创建的，scale 定义了数据和美学之间的独特映射。  

![](https://gitee.com/shao818/Figure/raw/master/20210609213127.png)

Scale 连接了数据值和美学值，上图中的数字 1 到 4 分别被映射到了一个位置尺度，形状尺度和颜色尺度，对于每一个尺度，每个数字对应一个唯一的位置，形状或颜色。最重要的是，尺度必须是一对一的，即对于每个特定的数据值存在一个美学值，反之亦然。如果一个尺度不是一对一的，那么得到的图形就会变得模糊。

首先，aes 选定了映射到各个美学属性的数据（变量）；然后，scale 将数据映射到真正的图形元素。如下面的代码：


```{r}
pacman::p_load(tidyverse, colorspace, corrr,  cowplot, 
   ggdark, ggforce, ggrepel, ggridges, ggsci, 
    ggtext, ggthemes, grid, gridExtra, patchwork,
    rcartocolor, scico, showtext, shiny, 
    plotly, highcharter, echarts4r)
```


aes 中的 fill = time 只是指定了映射到 fill （填充色）的数据是 Lunch 和 Dinner，也就是将 Lunch 的数据映射到一种颜色，将 Dinner 的数据映射为另一种颜色。而 scale 负责将 Lunch 的数据映射为红色，将 Dinner 的数据映射为青色，如下图所示：

```{r eval=FALSE, include=FALSE}
ggplot(data=dat, aes(x=time, y=total_bill, fill=time)) +
  geom_bar(stat="identity")
```

![](https://gitee.com/shao818/Figure/raw/master/20210609214007.png)  


![](https://gitee.com/shao818/Figure/raw/master/20210609214021.png)


代码中之所以没有出现 scale 的部分，是因为 ggplot2 有默认的映射，这些已经自动完成了。而如果你想要手动修改一些图形元素的映射时，则需要调用各种各样的 scale 函数，有许多不同类型的 scale，下面是一些常见的：

![](https://gitee.com/shao818/Figure/raw/master/20210609214112.png)

回归正题，ggplot2 在将分组变量映射到美学元素时，会自动添加一个图例：

```{r}
# 文件置于工作目录下
chic <- readr::read_csv("chicago-nmmaps.csv")
```

```{r}
ggplot(chic, aes(x = date, y = temp, color = season)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)")
```

> 默认情况下图例标题 season 是我们在 color 参数中指定的。  

## 关闭图例  

如果不需要图例，可以这样进行删除：  

```{r}
ggplot(chic, aes(x = date, y = temp, color = season)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)") +
  theme(legend.position = "none")
```

你也可以根据具体情况使用 guides(color = "none") 或 scale_color_discrete (guide = "none") 删除特定的图例，同时保留一些其他的。例如，我们可以保留形状的图例，删除颜色的图例：  

```{r}
ggplot(chic, aes(x = date, y = temp, color = season, shape = season)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)") +
  guides(color = "none")
```

## 移除图例标题  

删除图例上方的标题：

```{r}
ggplot(chic, aes(x = date, y = temp, color = season)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)") +
  theme(legend.title = element_blank())
```

也可以通过设置图例标题名为 NULL ，或者通过 scale_color_discrete(name = NULL) or labs(color = NULL) 来删除图例标题：

```{r}
ggplot(chic, aes(x = date, y = temp, color = season)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)") +
  scale_color_discrete(name = NULL)
```

```{r}
ggplot(chic, aes(x = date, y = temp, color = season)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)") +
  labs(color = NULL)
```

## 改变图例位置  

默认情况下图例会放在图形右边，如果你不想把图例放在右边，可以使用 theme 函数中的 legend.position 参数进行修改，可选项有：top，right（默认），bottom 和 left。

```{r}
ggplot(chic, aes(x = date, y = temp, color = season)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)") +
  theme(legend.position = "top")
```

也可以通过指定一个相对 x 和 y 坐标范围从 0 (左或下)到 1 (右或上) 的矢量来将图例放置在面板中：

```{r}
ggplot(chic, aes(x = date, y = temp, color = season)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)", color = NULL) +
  theme(legend.position = c(.15, .15),
        legend.background = element_rect(fill = "transparent"))
```  


> 同时这里也修改了默认的白色背景为透明背景，以保证图例不会遮挡任何数据点

## 改变图例方向

正如你看到的，图例的方向默认是竖直的，但当你选择将图例放在底部或顶部时，也可以将图例水平放置：

```{r}
ggplot(chic, aes(x = date, y = temp, color = season)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)") +
  theme(legend.position = c(.5, .97), legend.background = element_rect(fill = "transparent")) +
  guides(color = guide_legend(direction = "horizontal"))
```

## 改变图例标题的风格

图例标题的外观可以通过调整主题元素 legend.title 来改变：

```{r, fig.showtext=TRUE,fig.align="center"}
library(showtext)
font_add("SourceHanSerifCN-Light", "SourceHanSerifCN-Light.otf")
ggplot(chic, aes(x = date, y = temp, color = season)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)") +
  theme(legend.title = element_text(family = "SourceHanSerifCN-Light", color = "chocolate",
                                    size = 14, face = "bold"))
```

## 改变图例标题内容  

修改图例标题内容的最简单方法是 labs() 函数：

```{r, fig.showtext=TRUE,fig.align="center"}
ggplot(chic, aes(x = date, y = temp, color = season)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)", color = "Seasons\nindicated\nby colors:") +
  theme(legend.title = element_text(family = "SourceHanSerifCN-Light", color = "chocolate",
                                    size = 14, face = "bold"))
```


关于图例的更多细节可以通过 scale_color_discrete(name = ‘title’) 或 guides(color = guide_legend(‘title’)) 进行修改：

```{r, fig.showtext=TRUE,fig.align="center"}
ggplot(chic, aes(x = date, y = temp, color = season)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)") +
  theme(legend.title = element_text(family = "SourceHanSerifCN-Light", color = "chocolate",
                                    size = 14, face = "bold")) +
  scale_color_discrete(name = "Seasons\nindicated\nby colors:")
```

## 改变图例中的元素顺序  

对于图例中各个元素的排序，更改时可以通过改变变量 season 的水平来实现：  

```{r, fig.showtext=TRUE,fig.align="center"}
chic$season <-
  factor(chic$season, levels = c("Winter", "Spring", "Summer", "Autumn"))
ggplot(chic, aes(x = date, y = temp, color = season)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)")
```

## 改变图例标签  

使用月份来替换季节 season 作为图例标签的内容，通过 scale_color_discrete() 函数来提供一个名称向量：

```{r, fig.showtext=TRUE,fig.align="center"}
ggplot(chic, aes(x = date, y = temp, color = season)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)") +
  scale_color_discrete(name = "Seasons:", labels = c("Mar—May", "Jun—Aug", "Sep—Nov", "Dec—Feb")) +
  theme(legend.title = element_text(
    family = "SourceHanSerifCN-Light", color = "chocolate", size = 14, face = 2 ))
```

## 更改图例框的背景颜色

使用 legend.key() 函数中的 element_rect 进行修改

rect 设置主要用于设置图例和面板，主要参数如下：

```
element_rect(fill = NULL, colour = NULL, size = NULL, linetype = NULL, color = NULL)


```
```{r, fig.showtext=TRUE,fig.align="center"}
ggplot(chic, aes(x = date, y = temp, color = season)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)") +
  theme(legend.key = element_rect(fill = "darkgoldenrod1"),
        legend.title = element_text(family = "SourceHanSerifCN-Light", color = "chocolate",
size = 14, face = 2)) +
  scale_color_discrete("Seasons:")
```

## 改变图例符号的大小  

默认情况下图例中的点的大小可能会看不清楚，特别是没有方框时。可以使用 guides 进行调整：  

```{r, fig.showtext=TRUE,fig.align="center"}
ggplot(chic, aes(x = date, y = temp, color = season)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)") +
  theme(legend.key = element_rect(fill = NA),
        legend.title = element_text(color = "chocolate", size = 14, face = 2)) +
  scale_color_discrete("Seasons:") +
  guides(color = guide_legend(override.aes = list(size = 6)))
```

## 在图例上留下一个图层  

假设你有两个不同的 geoms 映射到同一个变量。例如，颜色作为同一数据的 point 图层和 rug 图层的美学。默认情况下，图例将同时包含点和线：  

```{r}
ggplot(chic, aes(x = date, y = temp, color = season)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)") +
  geom_rug()
```

可以使用 show.legend = FALSE 来关闭其中一个图层（此处为 rug 图层）：

```{r}
ggplot(chic, aes(x = date, y = temp, color = season)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)") +
  geom_rug(show.legend = FALSE)
```

## 手动添加图例项  

除非你将美学属性（颜色，大小等）映射给了一个变量，否则 ggplot2 不会自动地添加一个图例。但有时我们想要手动添加一个图例，这样你就能清楚地知道你在画什么：
这是一个默认图像：  

```{r}
ggplot(chic, aes(x = date, y = o3)) +
  geom_line(color = "gray") +
  geom_point(color = "darkorange2") +
  labs(x = "Year", y = "Ozone")
```

我们可以通过将 guide 映射到变量来强制生成图例。我们使用 aes() 映射线和点，但不是映射到数据集中的变量，而是映射到单个字符串（这样我们为每个字符串只获得一种颜色）。

```{r}
ggplot(chic, aes(x = date, y = o3)) +
  geom_line(aes(color = "line")) +
  geom_point(aes(color = "points")) +
  labs(x = "Year", y = "Ozone") +
  scale_color_discrete("Type:")
```

现在已经比较接近了，但这还不是我们想要的。我们想要灰色和红色！为了更改颜色，需要使用 scale_color_manual() 函数，同时我们使用 guide() 函数修改图例美学：

```{r}
ggplot(chic, aes(x = date, y = o3)) +
  geom_line(aes(color = "line")) +
  geom_point(aes(color = "points")) +
  labs(x = "Year", y = "Ozone") +
  scale_color_manual(name = NULL,  guide = "legend",
                     values = c("points" = "darkorange2",  "line" = "gray")) +
  guides(color = guide_legend(override.aes = list(linetype = c(1, 0),  shape = c(NA, 16))))
```

## 使用其它图例风格

正如前面的几个例子，分类变量（如 season）的默认图例是 guide_legend()，如果你将一个连续变量映射到美学，ggplot2 默认情况下不会使用 guide_legend()，而是使用 guide_colorbar()(或 guide_colourbar)：

```{r}
ggplot(chic, aes(x = date, y = temp, color = temp)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)", color = "Temperature (°F)")
```

然而，通过使用 guide_legend()，你可以强制图例在给定的断点数目中显示离散的颜色，就像分类变量的情况一样：

```{r}
ggplot(chic, aes(x = date, y = temp, color = temp)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)", color = "Temperature (°F)") +
  guides(color = guide_legend())
```

你也可以使用 binned 颜色图例：

```{r}
ggplot(chic, aes(x = date, y = temp, color = temp)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)", color = "Temperature (°F)") +
  guides(color = guide_bins())
```

或者离散颜色条的 binned 图例：

```{r}
ggplot(chic, aes(x = date, y = temp, color = temp)) +
  geom_point() +
  labs(x = "Year", y = "Temperature (°F)", color = "Temperature (°F)") +
  guides(color = guide_colorsteps())
```

#  背景与网格线

## 修改网格线的美学属性  

网格线分为两种：表示刻度的网格线（主网格线）和网格线之间的小网格线（副网格线）。网格线可以通过修改 panel.grid 的默认值来更改，或为每一组网格线使用 panel.grid.major（主网格线）和 panel.grid.minor（副网格线）：  

```{r}
ggplot(chic, aes(x = date, y = temp)) +
  geom_point(color = "firebrick") +
  labs(x = "Year", y = "Temperature (°F)") +
  theme(panel.grid.major = element_line(color = "gray10", size = .5),
        panel.grid.minor = element_line(color = "gray70", size = .25))
```

你甚至可以为所有四个不同的级别的网格线（x/y轴主、副网格线）进行分别修改：


```{r}
ggplot(chic, aes(x = date, y = temp)) +
  geom_point(color = "firebrick") +
  labs(x = "Year", y = "Temperature (°F)") +
  theme(panel.grid.major = element_line(size = .5, linetype = "dashed"),
        panel.grid.minor = element_line(size = .25, linetype = "dotted"),
        panel.grid.major.x = element_line(color = "red1"),
        panel.grid.major.y = element_line(color = "blue1"),
        panel.grid.minor.x = element_line(color = "red4"),
        panel.grid.minor.y = element_line(color = "blue4"))
```

当然，你可以删除网格线：  

### 删除副网格线

```{r}
ggplot(chic, aes(x = date, y = temp)) +
  geom_point(color = "firebrick") +
  labs(x = "Year", y = "Temperature (°F)") +
  theme(panel.grid.minor = element_blank())
```

### 删除全部网格线  

```{r}
ggplot(chic, aes(x = date, y = temp)) +
  geom_point(color = "firebrick") +
  labs(x = "Year", y = "Temperature (°F)") +
  theme(panel.grid = element_blank())
```

此外，你还可以定义主要和次要网格线之间的间断：  

```{r}
ggplot(chic, aes(x = date, y = temp)) +
  geom_point(color = "firebrick") +
  labs(x = "Year", y = "Temperature (°F)") +
  scale_y_continuous(breaks = seq(0, 100, 10), minor_breaks = seq(0, 100, 2.5))
```

## 改变面板背景颜色  

为了改变面板区域的背景颜色（填充），需要调整主题元素 panel.background：  

```{r}
ggplot(chic, aes(x = date, y = temp)) +
  geom_point(color = "#1D8565", size = 2) +
  labs(x = "Year", y = "Temperature (°F)") +
  theme(panel.background = element_rect( fill = "#64D2AA", color = "#64D2AA", size = 2))
```

 注意，即使我们指定了面板背景的轮廓，它的真实颜色也没有改变。这是因为在paneal.ground 的顶部还有一个图层，即 panel.border。确保使用一个透明的填充，否则你的数据隐藏在这个图层后面。
 
 
```{r}
ggplot(chic, aes(x = date, y = temp)) +
  geom_point(color = "#1D8565", size = 2) +
  labs(x = "Year", y = "Temperature (°F)") +
  theme(panel.border = element_rect(fill = "#64D2AA99", color = "#64D2AA", size = 2))
```
 
 
## 改变图像的背景颜色  
类似地，为了改变 plot 区域的背景颜色填充，我们需要修改 plot.background 的主题元素：  

```{r}
ggplot(chic, aes(x = date, y = temp)) +
  geom_point(color = "firebrick") +
  labs(x = "Year", y = "Temperature (°F)") +
  theme(plot.background = element_rect(fill = "gray60", color = "gray30", size = 2))
```


```{r}
ggplot(chic, aes(x = date, y = temp)) +
  geom_point(color = "firebrick") +
  labs(x = "Year", y = "Temperature (°F)") +
  theme(plot.background = element_rect(fill = "gray60", color = "gray30", size = 2))
```


在 panel.background 和 plot.background 中设置相同的颜色来实现一个独特的背景颜色，或者设置面板的背景填充为 transparent 或 NA：

```{r}
ggplot(chic, aes(x = date, y = temp)) +
  geom_point(color = "firebrick") +
  labs(x = "Year", y = "Temperature (°F)") +
  theme(panel.background = element_rect(fill = NA),
        plot.background = element_rect(fill = "gray60",  color = "gray30", size = 2))
```


## 图边距（Margins）  

有时在图形边距上增加一点空间是很有用的。与前面的例子类似，我们可以修改 theme() 函数的参数 plot.margin。在前面的例子中，我们已经通过使用 plot.background 改变背景颜色来说明默认的边距。现在让我们在左右两边都添加额外的空间。参数 plot.margin 可以处理各种不同的单位（厘米、英寸等），但它需要使用 grid 包中的函数来定义这些单位。这里我使用了 5 厘米左右的边距：  

```{r}
ggplot(chic, aes(x = date, y = temp)) +
  geom_point(color = "firebrick") +
  labs(x = "Year", y = "Temperature (°F)") +
  theme(plot.background = element_rect(fill = "gray60"),
        plot.margin = margin(t = 1, r = 3, b = 1, l = 8, unit = "cm"))
```

>边缘边的顺序是上top、右right、下bottom、左left


- [A ggplot2 Tutorial for Beautiful Plotting in R：](https://www.cedricscherer.com/2019/08/05/a-ggplot2-tutorial-for-beautiful-plotting-in-r/#prep)  

- [数据可视化基础：](https://clauswilke.com/dataviz/)

- [数据及代码下载：](https://osf.io/3kbw5/)  

<font size=2>
