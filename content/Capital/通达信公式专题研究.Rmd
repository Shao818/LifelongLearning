---
author:
  - 通达信公式
title: '通达信公式'
categories:
  - 通达信
  - 选股策略
tags:
  - 通达信
  - 选股策略
date: 2021-12-30
slug: TDX
weight: 001
description: <font face="思源宋体 CN" >通达信公式研究系列</font>
---



# 关键概念

## 公式编辑器

<font face="思源宋体 CN" >

　　公式管理器可管理四种类型的公式：    

- 指 标 公 式： 用于指标图形的绘制。    
- 条件选股公式：用于条件选股。     
- 交易系统公式：用于专家指示及测参、测指。     
- Ｋ线公式：用于Ｋ线模式指示。   


>这四种公式相互独立，名称可以相同，但其内容和作用不同。  


　　**每种类型的公式包括四种形式：**  
　　系统加密公式：用绿色图标和锁形符号显示，要进行密码确认。   
　　系统公式：用绿色图标显示，可进行删改。   
　　用户加密公式：用红色图标和锁形符号显示，要进行密码确认。    
　　用户公式：用红色图标显示，可进行删改。


>指标公式附加买卖逻辑判断式，得到交易系统公式；指标公式附加选股条件逻辑判断式，得到条件选股公式。指标公式附加色彩逻辑判断，得到五彩K线公式。

　　**公式管理器可管理四种类型的公式：**  

- 技术指标公式：用于指标图形的绘制。  
- 条件选股公式：用于条件选股。   
- 专家系统公式：用于专家指示及测参、测指。   
- 五彩K线公式：用于K线模式指示。    
- 这四种公式相互独立，名称可以相同，但其内容和作用不同。   

## 技术指标公式编辑器？   

　　技术指标公式即通常所说画线指标，此类公式的主要目的是通过对数据采取一定的运算，将输出结果直观的显现在分析图上，为投资者提供研判行情的基本依据。此类指标至少要有一条输出线，输出包括文字,图标等，本系统老版本允许最多6条的输出线，新版本可以输出50条输出线。技术指标公式编辑器实现对技术图表分析中各类技术指标和自我定义的技术分析指标的编写，并且通过TDX的分析界面形成图表、曲线，以方便和寻找有意义的技术图形和技术特征。

　　**注意事项**：


- 1 、如果选择： “ 主图叠加 ” ，我们的指标线会与 K 线图显示在同一个图形框中，现在我们的指标线显示在其下方，即 “ 副图 ” 中；    
- 2 、参数可以有，也可以没有，但是鼓励大家设置参数，这是非常好的习惯；   

- 3 、一个句子完了，别忘了以分号结尾；
你的公式写得对不对，可以通过 “ 测试公式 ” 来检查，如果错了，它会告诉你错在哪里。

### 条件选股公式编辑器   

　　也就是通常意义上解释的智能选股。但我们的目的在于建立一个完全开放、自由的选股平台，可以通过对该平台的熟练使用，借助计算机的高速和准确的检索功能寻找满足您的理解的股票形态和技术特征，如果和预警系统结合起来用，将可以在盘中实时提示符合条件的股票。条件选股公式有且仅有一个输出，这是它和技术指标不同的地方。

> 1 、指标和条件选股在结构上没有差别，只是在内容上，条件选股要多加上我们的条件，比如大于 10 ，或者交叉等等！  
2 、中间表达式可以帮助我们清晰的表达我们的公式，不至于使公式的结构特别的混乱！


### 画线指标公式编辑器

- ［公式名称］用于识别指标公式，不能重名，最多可以有16个字符。键盘精灵也用该名称来选择公式。
- ［公式描述］简单描述该指标的用途。
- ［密码保护］如果其前未打√，表示该公式没加密。点击"密码保护"，使其打√选中，此时输入密码，公式就被加密。对于已加密的公式，必须输入密码才能看到公式的内容，要去掉密码，点击"密码保护"，使它前面的√消失即可。
- ［指标类型］指定指标公式类型（共分为15种）。
- ［画线方法］紧密围绕股票价格变化的指标可定为主图叠加类型，叠加在主图上显示；否则定为副图指标，只能显示在副图上。
- ［参数名称］公式可以带参数，参数的名字在这里输入。
- ［最小值、最大值、缺省值］参数的最小值、最大值和默认值（缺省值）在这里输入。
- ［坐标线位置］仅对副图指标有效，可指定在哪些位置画水平坐标线，例如对BIAS，可以输入：-20；0；20； 系统将在这三个数值处绘制三条水平坐标线。缺省时为"自动"，即系统据实际情况定水平坐标线。
- ［额外Y轴分界］
- ［引入指标公式］以系统已有的某个指标公式为蓝本，新建自己的指标公式。
- ［插入函数］显示选择函数对话框，帮助您在《通达信集成版》软件函数集中寻找所需函数。当您对系统提供的标准函数还不熟时，这个功能可帮你节省时间。

- 　Tdxw3.0将函数类型分为：
全部函数 行情函数 时间函数 引用函数 逻辑函数
数学函数 统计函数 指数函数 大盘函数 常数函数
内嵌函数 操作符函数
- 　[动态提示]用户输入指标、算法或函数时，同步提示中文语意。
- [测试公式]公式编写完毕后检查公式的语法错误。
- [测试结果]测试完毕后提示"测试通过"或显示错误信息。
- [参数精灵]用户新建公式时，可在参数精灵中用一段文字来描述待设置参数的意义，这段解释性文字会在允许用户调整参数值的地方出现，包括条件选股、指标排序、调整指标参数、选择指标、选择交易系统指示、选择条件选股指示等等。有了这段解释性文字的指导，用户就不会盲目操作了。



### 交易系统公式编辑器           

　　交易系统公式是通过设定买入和卖出点(有且仅有这两个输出)，由计算机进行模拟操作。以此为依据，系统一方面可以进行五彩K线公式的功能，同时提示买入和卖出；另一方面可以通过模拟操作，对指标买卖的收益、指标的最佳参数及最佳指标等各情形进行测试。交易系统是在条件选股功能上的一次大的延伸，旨在建立一套完整的交易规则体系，通过该编辑器对各个相关的交易环节，包括买入的切入、卖出、止损以及整体的交易性能检验等等作出定量的规定，帮助投资者建立一套属于自己的买卖规则和理论。　　　  

- ［测试步长］在进行参数优化时，每次参数变化的大小。   

- ［多头买入］做多时的买入条件在此输入，买入点指示的颜色及式样也请在此选定。   

- ［多头卖出］　做多时的卖出条件在此输入，卖出点指示的颜色及式样也请在此选定。   

- ［空头买入］　做空时的买入条件在此输入，买入点指示的颜色及式样也请在此选定。   

- ［空头卖出］做空时的卖出条件在此输入，卖出点指示的颜色及式样也请在此选定。  


### 五彩K线公式编辑器         

　　准确讲，该编辑器的功能是附属于条件选股功能之上的，我们可以通过该功能将满足条件的连续K线形态赋予颜色，区别了其它的K线。 条件选股公式与五彩K线公式的区别：条件选股公式和五彩K线公式都有且仅有一个输出，其目的都是为投资者提供买入或卖出点的指示，不同之处在于：条件选股公式仅对最近数据提示买入或卖出，而五彩K线公式则对输入的所有历史数据进行提示。另外，五彩K线公式的输出是在K线图上，通过各种颜色对提示数据进行标识，条件选股公式的输出是找出符合最近条件的所有股票。


### 参数   

　　比如讲： 10 日均线，您可以把 10 日当作参数，好处在于，您觉得需要修改成 5 日的时候，就可以使用一些简单的方法，例如参数精灵来很方便的修改和调整。参数需要名字，例如 M 就不错。还要规定参数的范围，例如 1 日至 260 日。这样我们就可以在 1 到 260 之间任意调节 M 的值了， M 最常用的数填在 “ 缺省 ” 一栏，例如你最喜欢用 10 日均线，那就填 10 吧。

### 周期

　　这么解释吧！我们有的投资者喜欢使用日线图作技术分析；有的喜欢用 5 分钟的 K线；有的喜欢使用长一点时间的，例如周线。所以在公式设计中，允许不同喜好的使用者选择不同的分析时间 ，就是可以选择不同的周期。

## 函数

　　函数在公式编写非常重要，如果作个比喻，我们用一种语言去告诉电脑我的想法，并且让它去帮我做，那么函数就是这种语言的单词。
我们在公式编辑器中选择插入函数，就可以看到里面有许多的函数，我们在附录中有一个简表，大家可以到那里去检索！

>[通达信函数链接](https://www.tdx.com.cn/products/helpfile/tdxw/index.html)

## 重要函数

###  行情函数

- `HIGH`或`H`，最高价，返回该周期最高价。

- `LOW`或`L`， 最低价，返回该周期最低价。

- `CLOSE`或`C`， 收盘价，返回该周期收盘价。

- `VOL`或`V`， 成交量（手），返回该周期成交量。

- `OPEN`或`O`， 成交量（手），返回该周期开盘价。

###  逻辑函数

- `CROSS`, 上穿。用法:
`CROSS(A,B)`表示当A从下方向上穿过B时返回1,否则返回0。例如:
`CROSS(MA(CLOSE,5),MA(CLOSE,10))`表示5日均线与10日均线交金叉


- `LONGCROSS`, 维持周期后上穿，两条线维持一定周期后交叉。用法:
`LONGCROSS(A,B,N)`表示A在N周期内都小于B,本周期从下方向上穿过B时返回1,否则返回0。


- `UPNDAY`, 连涨，返回是否连涨周期数。用法:
`UPNDAY(CLOSE,M)`表示连涨M个周期,M为常量。


- `DOWNNDAY`, 连跌，返回是否连跌周期。用法:
`UPNDAY(CLOSE,M)`表示连跌M个周期,M为常量。


- `NDAY`, 连大，返回是否持续存在X>Y。用法:
`NDAY(CLOSE,OPEN,3)`表示连续3日收阳线。

- `EXIST`, 存在，是否存在。用法:
`EXIST(CLOSE>OPEN,10)`表示10日内存在着阳线。  




- `EXISTR`, 存在，EXISTR(X,A,B):是否存在(前几日到前几日间)。用法:
`EXISTR(CLOSE>OPEN,10,5)`表示从前10日内到前5日内存在着阳线
若A为0,表示从第一天开始,B为0,表示到最后日止。


- `EVERY`, 一直存在，用法:
`EVERY(CLOSE>OPEN,N)`表示N日内一直阳线(N应大于0,小于总周期数,N支持变量)。

- `LAST`, 持续存在，用法:
`LAST(X,A,B)`，持续存在。`LAST(CLOSE>OPEN,10,5)`表示从前10日到前5日内一直阳线
若A为0,表示从第一天开始,B为0,表示到最后日止。

- `NOT`, 取反，用法:
`NOT(X)`返回非X,即当X=0时返回1,否则返回0。`NOT(ISUP)`,表示平盘或收阴。


- `IF`, 逻辑判断。根据条件求不同的值。用法：　IF(X，A，B)　若X不为0则返回A，否则返回B。例如：IF(CLOSE>OPEN,HIGH,LOW)表示该周期收阳则返回最高值,否则返回最低值  

- `IFF`,  逻辑判断  

　　根据条件求不同的值。用法：IFF(X，A，B)　若X不为0则返回A，否则返回B。
例如：　IFF(CLOSE>OPEN,HIGH,LOW)表示该周期收阳则返回最高值,否则返回最低值   

- `IFN`, 逻辑判断  

　　根据条件求不同的值。用法：IFN(X，A，B)　若X不为0则返回B，否则返回A。　例如：IFN(CLOSE>OPEN,HIGH,LOW)表示该周期收阴则返回最高值,否则返回最低值

- `MAX` 较大值  

　　求最大值。用法：MAX(A,B)　返回A和B中的较大值。例如：MAX(CLOSE-OPEN,0)表示若收盘价大于开盘价返回它们的差值,否则返回。  

- `MIN` 较小值   

　　求最小值。用法：MIN(A，B)　返回A和B中的较小值。例如：MIN(CLOSE,OPEN)返回开盘价和收盘价中的较小值。  


### 引用函数  

#### 引用扩展数据：EXTDATA_USER 

　　引用扩展数据。请用扩展数据管理器来设置和刷新数据。


　　EXTDATA_USER(N,TYPE),N取(1-100),表示读当前品种的N号扩展序列数据,TYPE:1表示做平滑处理,没有数据的周期返回上一周期的值;0表示不做平滑处理;2表示没有数据则为0。

#### 日前的：REF       

　　引用若干周期前的数据（平滑处理）

　　用法：REF(X , A) 引用 A 周期前的 X 值。A可以是变量 。 ( 平滑处理：当引用不到数据时进行的操作。此函数中，平滑时使用上一周期的引用值。 )

　　例如：`REF(CLOSE ,BARSCOUNT(C)-1) `表示第二根 K 线的收盘价。

#### 日前的（未作平滑处理）：REFV       

　　引用若干周期前的数据（未作平滑处理）

　　用法：REFV(X , A) 引用 A 周期前的 X 值。A可以是变量。( 平滑处理：当引用不到数据时进行的操作。)

　　例如：`REFV(CLOSE , BARSCOUNT(C)-1) `表示第二根K线的收盘价

#### 统计：COUNT

　　统计满足条件的周期数。用法:  

　　`COUNT(X,N)`,统计N周期中满足X条件的周期数,若N<0则从第一个有效值开始。
例如:`COUNT(CLOSE>OPEN,20)`表示统计20周期内收阳的周期数。

#### 最高值：HHV  

　　求最高值。用法：`HHV(X,N) `求 N 周期内 X 最高值，N=0 则从第一个有效值开始。  

　　例如：`HHV(HIGH,30)`表示求30日最高价。


#### 最低值：LLV    

　　求最低值。    

　　用法：LLV(X,N) 求 N 周期内 X 最低值， N=0 则从第一个有效值开始。   

　　例如：LLV(LOW,0) 表示求历史最低价。  

#### 上一高点位置：HHVBARS  

　　求上一高点到当前的周期数。

　　用法：HHVBARS(X,N) 求 N 周期内X最高值到当前周期数,N=0 表示从第一个有效值开始统计。

　　例如： `HHVBARS(HIGH,0)` 求得历史新高到到当前的周期数。



#### 上一低点位置：LLVBARS       

　　求上一低点到当前的周期数。    

　　用法：LLVBARS(X,N) 求 N 周期内 X 最低值到当前周期数， N=0 表示从第一个有效值开始统计。   

　　例如：LLVBARS(HIGH,20) 求得 20 日最低点到当前的周期数。 


#### 高值名次：HOD   

　　求高值名次，用法： `HOD(X,N)` 求当前 X 数据是 N 周期内的第几个高值 ,N=0 则从第一个有效值开始。

　　例如： `HOD(HIGH,20)` 返回是 20 日的第几个高价。


#### 低值名次：LOD       

　　求低值名次，用法： LOD(X,N) 求当前 X 数据是 N 周期内的第几个低值， N=0，则从第一个有效值开始

　　例如： LOD(LOW,20)返回是 20 日的第几个低价 



#### 求相反数：REVERSE       

　　求相反数。用法：　 REVERSE(X) 返回 -X 。

　　例如：　 REVERSE(CLOSE) 返回 -CLOSE 。





#### 日后的：REFX       

　　属于未来函数,引用若干周期后的数据(平滑处理)。    

　　用法:REFX(X,A),引用A周期后的X值.A可以是变量。   

　　平滑处理:当引用不到数据时进行的操作.此函数中,平滑时使用上一个周期的引用值.
例如:    
```
TT:=IF(C>O,1,2);  
REFX(CLOSE,TT);    
```

　　表示阳线引用下一周期的收盘价,阴线引用日后第二周期的收盘价。  


#### 日后的 (未作平滑处理)：REFXV         

　　属于未来函数,引用若干周期后的数据(未作平滑处理)。   

　　用法:  

　　`REFXV(X,A)`,引用A周期后的X值.A可以是变量。  

　　平滑处理:当引用不到数据时进行的操作。  

　　例如:  

　　`REFXV(CLOSE,1)`表示下一周期的收盘价,在日线上就是明天收盘价。


#### 简单移动平均：MA         

　　返回简单移动平均。

　　用法：　 MA(X,N):X的N日简单移动平均,算法(X1+X2+X3+...+Xn)/N,N支持变量


#### 移动平均：SMA         

　　返回移动平均。

　　用法： SMA(X,N,M):X的N日移动平均,M为权重,如Y=(X*M+Y'*(N-M))/N


#### 移动平均：TMA         

　　返回移动平均

　　用法： TMA(X,A,B),A和B必须小于1,算法 Y=(A*Y'+B*X),其中Y'表示上一周期Y值.初值为X


#### 平滑移动平均：MEMA         

　　返回平滑移动平均

　　用法：

　　`MEMA(X,N)`:X的N日平滑移动平均,如Y=(X+Y'*(N-1))/N；


　　`MEMA(X,N)`相当于`SMA(X,N,1)`。


#### 指数移动平均：EMA          

　　返回指数移动平均。

　　用法：`EMA(X ,N) `,X 的 N日指数移动平均。算法 :Y=(X*2+Y'*(N-1))/(N+1)。

　　`EMA(X,N)`相当于`SMA(X,N+1,2)`,N支持变量。




### 绘图函数

#### 绘制图标：DRAWICON    


　　在图形上绘制小图标。   

　　用法：DRAWICON(COND，PRICE，TYPE)，当COND条件满足时，在PRICE位置画TYPE号图标。   

　　例如：DRAWICON(CLOSE>OPEN,LOW,1)表示当收阳时在最低价位置画1号图标。  

　　图标一共有九个，图形如附图。序号，最下面的是“1”号，最上面的是“9”号。     


#### 显示文字：DRAWTEXT     

　　在图形上显示文字。   

　　用法：DRAWTEXT(COND，PRICE，TEXT)，当COND条件满足时，在PRICE位置书写文字TEXT。   

　　例如：DRAWTEXT(CLOSE/OPEN>1.08,LOW,'大阳线')表示当日实体阳线大于8%时在最低价位置显示'大阳线'字样。

## 公式示例

### 放量

- 1、 今日比昨日的成交量放大了1倍　 


　　VOL/REF(VOL,1)>2;　　

- 2、今日的五日均量比五天前的五日均量放大了3倍　　

　　AA:=MA(VOL,5);
　　BB:=REF(AA,5);
　　AA/BB>4;

- 3、今天的成交量达到了整个流通盘的10%以上　　

　　VOL/CAPITAL>10/100;　（注意，10%的表达式是10/100，或者0.1）


###  缩量


- 1、	今日比昨日的成交量缩小了1倍：  

　　VOL/REF(VOL,1)<0.5;

- 2、	今日的五日均量比五天前的五日均量缩小了一半：

 
　　AA:=MA(VOL,5);
　　BB:=REF(AA,5);
　　AA/BB<0.5;

- 3、	今天的成交量不足整个流通盘的0.5%：  

VOL/CAPITAL<0.5/100;


###  上涨


- 1、今日涨幅达到了7%以上：  

CLOSE/REF(CLOSE,1)>1.07;  

- 2、十日均价继续上涨：  

　　AA:=MA(CLOSE,10); 
　　
　　BB:=REE(AA,1);  
　　
　　AA>BB;


###  下跌

　　收阳、收阴：  

- 1、当天收阳：CLOSE>OPEN;  

- 2、当天收阴：CLOSE<OPEN;  

###  高开、低开

- 1、当天股价高开，即开盘高于昨日收盘：OPEN>REF(CLOSE,1);
- 2、当天股价低开：OPEN<REF(CLOSE,1);

###  跳空

　　跳空亦有向上和向下两种：   
　　
　　当日开盘在昨日最高之上，即为向上跳空：OPEN>REF(HIGH,1);
反之，开盘小于昨日的最高价，为向下跳空：OPEN<REF(LOW,1);

###  放量上攻

　　AA:=VOL/REF(VOL,1)>2;{成交量是昨日的两倍}  

　　BB:=CLOSE/REF(CLOSE,1)>1.07;{涨幅大于7%}  

　　AA AND BB;

###  高开高走

　　AA:=VOL/REF(VOL,1)>2;{成交量是昨日的两倍}  

　　BB:=CLOSE/REF(CLOSE,1)>1.07;{涨幅大于7%}  

　　AA AND BB;  

###  创新高

　　创新高指当日最高价是最近一段时间的最高价：  

　　HIGH=HHV(HIGH,N);  

　　其中的HIGH为当期最高价，HHV(X,N)是求N周期内X最高值。因此该公式的含义是当日最高价创Ｎ日新高时返回值为１，否则为０。 


###  横盘整理  

　　横盘整理指最近一段时期价格在一定幅度之内摆动：  

　　(HHV(CLOSE,10)-LLV(CLOSE,10))/CLOSE<0.05;  

　　其中的LLV(X,N)是求N周期内X最低值。因此该公式表示10日收盘价振幅振幅在5%以内。

### 公式组合实例  

#### 向上跳空之后两天内并未回补  

　　定义：实际上就是昨天发生了跳空缺口，这两天的最低价一直在两天前的最高价之上。

![](https://gitee.com/shao818/Figure/raw/master/20211231191308.png)

```
AA:=REF(OPEN,1)>REF(HIGH,2);
BB:=REF(LOW,1)>REF(HIGH,2);
CC:=LOW>REF(HIGH,2);
AA AND BB AND CC;
```

　　仔细一想，若BB成立，AA一定成立，AA实际上没有存在的必要。
更简单的方法，下面的一句话可以的上面的四句：

```
COUNT(LOW>REF(HIGH,2),2)=2;
````

#### 5日，10日，30日均线多头排列

　　定义：均线多头排列，是指从短周期到长周期均线，从上而下的依次排列。

![](https://gitee.com/shao818/Figure/raw/master/20211231191639.png)




```
AA:=MA(CLOSE,5);
BB:=MA(CLOSE,10);
CC:=MA(CLOSE,30);
T1:AA>BB AND BB>CC;
```


　　以上情况维持一段时间，假设我们这里定为4天以上：   

```
COUNT(T1,4)=4;
```
COUNT（X，N）表示统计在N天内满足条件X的有几天。


　　最终的结果就是如下所示：
```
AA:=MA(CLOSE,5);
BB:=MA(CLOSE,10);
CC:=MA(CLOSE,30);
T1:=AA>BB AND BB>CC;
COUNT(T1,4)=4;
```  

#### 逃顶K线形态之--黄昏之星

　　定义：当市场出现一条大阳线后，通常会产生跳空高开的情况，有时便会出现十字星或类似十字星的小阴线（小阳线），当该形态出现在一段上升行情的当中，就很容易形成经典K线形态--黄昏之星。  

![](https://gitee.com/shao818/Figure/raw/master/20211231191706.png)  

　　为了结构简单起见，首先将二天的高开低收用中间表达式表达出来，因为我们在后面的编写过程中会分别使用到这些数据。

　　1、今日K线的：    
　　开-a1, a1：=open；   
　　收-a2， a2：=close；  
　　高-a3, a3：=high；   

　　2、昨天K线的：   
　　开-b1, b1：=ref(open，1)；  
　　收-b2， b2：=ref(close，1)；  
　　高-b3， b3：=ref(high，1)；   
　　低-b4， b4：=ref(low，1)；    

　　3、前天K线的：   
　　开-c1, c1：=ref(open，2)；  
　　收-c2, c2：=ref(close，2)；  
　　高-c3, c3：=ref(high，2)；   
　　低-c4, c4：=ref(low，2)；   

　　4、我们将会分别描述出三天的K线形态，然后汇总，首先我们观察今日K线的特征，今天 
   是一根低开低走的大阴线，我们给它一些数字上的定义：   
　　a、今日开盘价小于昨日收盘价： aa:=a1＜b2 and     
　　b、今日的阴线实体较长，我们用开盘价和收盘价相比，长度大于4%：a1/a2＞1.04；     
  
　　5、昨日K线的特征，是一根十字形态的K线，并且在左右两根K线之上，分别表达为:  
　　a、昨日跳开，高于前天的收盘： bb：=b1＞c3      
　　b、昨日收盘同样在缺口之上： and b2＞c3      
　　c、线形实体长度很小，也就是昨日开盘和收盘之差比昨日开盘的值小于0.01：and abs(b1-b2)/b1＜0.01     
　　d、K线有上下影线，可以表示为最高价和最低价不等于收盘价也不等于开盘价：and b3＞b1 and b3＞b2 and b4＜b1 and b4＜b2      
　　e、当日的最高价为20天以来的最高价： and b3=hhv(high，20)；  

　　6、前日K线的特征：股价大幅上扬，幅度较前一日收盘高出4%并且收盘大于开盘：cc:=c2/ref(close，3)＞1.04 and c2＞c1；  


　　综合选股条件：最后我们将三天的K线特征结合起来，合成一个最后的条件就是由图所示内容： aa and bb and cc

　　最终结果就是（可以直接加进通达信公式编辑器）： 

```
a1:=open;
a2:=close;
a3:=high;
b1:=ref(open,1);
b2:=ref(close,1);
b3:=ref(high,1);
b4:=ref(low,1);
c1:=ref(open,2);
c2:=ref(close,2);
c3:=ref(high,2);
c4:=ref(low,2);
aa:=a1<b2 and a1/a2>1.04;
bb:=b1>c3 and b2>c3 and abs(b1-b2)/b1<0.01 and b3>b1 and b3>b2 and b4<b1 and b4<b2 and b3=hhv(high,20);
cc:=c2/ref(close,3)>1.04 and c2>c1;
aa and bb and cc;
````

　　如果我们想把这个选股公式改为指标公式，修改最后一个语句就可以了。
　　将aa and bb and cc; 改为DRAWICON((AA AND BB AND CC),HIGH*1.02,2);
　　这时在符合条件的K线上方出现了一个绿色的向下箭头，提示卖出。效果如下：

![](https://gitee.com/shao818/Figure/raw/master/20211231191906.png)

　　黄昏之星是一个卖出信号，与之相对应的是一个买入信号，称为早晨之星，如下图：

![](https://gitee.com/shao818/Figure/raw/master/20211231191947.png)


### 突破底部横盘整理创新高   

　　定义：股价突破长期盘整区间，之后放量上攻进入主升段。“长期”设定为150天；“横盘”设定股价在150日均线上下15%波动；放量；并且股价创下150天以来的历史新高。

　　**首先用公式描述放量**    
　　a、将会使用5日均量来进行比较，成交量比昨日成交量放大两倍；    
　　b、V1是五日均量，REF（V1，1）就是昨日的均量；   
　　V1:=MA(VOL,5);    
　　V2:VOL/REF(V1,1)>2;  

　　**长期横盘**       
　　a、PZ1是当天150日均价： PZ1：=MA（CLOSE，M）；      
　　b、PZ2是150日的最高价； PZ2：=HHV（HIGH，M）；      
　　c、PZ3是150日的最低价； PZ3：=LLV（LOW，M）；      
　　d、PZ4是150日的最高价和150日均价的距离的百分比，PZ5刚好相反是最低价和均价的差的百分比；          PZ4：=（PZ2-PZ1）/PZ1； PZ5：=（PZ1-PZ3）/PZ1；      
　　e、设为股价在150日均线上下15%波动，也就是PZ4、PZ5都小于0.15；      
　　PZ:=REF(PZ4,1)<0.15 AND REF(PZ5,1)<0.15;         

　　**今天创下历史新高，也就是今天的最高价是150天内的最高价！**          
　　TP1:HHV(HIGH,M);   
　　TP:=HIGH=TP1;    

　　综合三个条件的最后的逻辑判断式就是我们的最后结论：V2 AND PZ AND TP（参数M=150天）。最终结果就是：（参数M=150天）
```
V1:=MA(VOL,5);
V2:=VOL/REF(V1,1)>2;
PZ1:=MA(CLOSE,M);
PZ2:=HHV(HIGH,M);
PZ3:=LLV(LOW,M);
PZ4:=(PZ2-PZ1)/PZ1; 
PZ5:=(PZ1-PZ3)/PZ1;
PZ:=REF(PZ4,1)<0.15 AND REF(PZ5,1)<0.15;
TP1:HHV(HIGH,M);
TP:=HIGH=TP1;
V2 AND PZ AND TP;
````
>注意：如果源码加入到公式编辑器后显示错误，请多注意标点符号，需要将中文模式下的标点改成英文模式下的标点，例如：“：”改成“:”， “，”改成“,”以及括号等等。



# 选股公式     


## RPS强势个股

```
{强势个股，最近5日（参数D控制）的RPS10、RPS20均大于85（参数R控制）}

{计算个股10日RPS，并判断该指标最近5日是否连续大于临界值}
K10 := EXTDATA_USER(5, 0);
RPSK10 := K10/10;
TJ1 :=EVERY(RPSK10>R,D);{判断最近5日的RPS10指标是否连续均大于临界值}

{计算个股20日RPS，并判断该指标最近5日是否连续大于临界值}
K20 :=  EXTDATA_USER(4, 0);
RPSK20 :=K20/10;
TJ2 :=EVERY(RPSK20>R,D);{判断最近5日的RPS20指标是否连续均大于临界值}

{综合条件;}
TJ1 AND TJ2;
```



## RPS强势板块

```
{强势板块，最近5日（参数D控制）的RPS10、RPS20均大于85（参数R控制）}

{计算板块10日RPS指标，并判断该指标最近5日是否连续大于临界值}
K10 := EXTDATA_USER(6, 0);
RPSK10 := K10/10;
TJ1 :=EVERY(RPSK10>R,D);{判断最近5日的10日RPS10指标是否连续均大于临界值}


{计算板块20日RPS指标，并判断该指标最近5日是否连续大于临界值}
K20 := EXTDATA_USER(7, 0) ;
RPSK20 :=K20/10;
TJ2 :=EVERY(RPSK20>R,D);{判断最近5日的20日RPS10指标是否连续均大于临界值}

{综合条件;}
TJ1 AND TJ2;
```
![](https://gitee.com/shao818/Figure/raw/master/截图_20211931101911.png)

筛选结果示例：

![](https://gitee.com/shao818/Figure/raw/master/截图_20212031102013.png)

## 底部横盘突破

```
V1 := MA(VOL, 5); {5日均量}
V2 := VOL / REF(V1, 1) > 2; {今日成交量大于昨日的5日均量的2倍}

PZ1 := MA(CLOSE, M); {今日的M日收盘均价}
PZ2 := HHV(HIGH, M); {M日最高价}
PZ3 := LLV(LOW, M); {M日最低价}
PZ4 := (PZ2 - PZ1) / PZ1; {PZ2和PZ1价格差的百分比}
PZ5 := (PZ1 - PZ3) / PZ1; {PZ1和PZ3价格差的百分比}
PZ := REF(PZ4, 1) < 0.15 AND REF(PZ5, 1) < 0.15; {昨日的PZ4小于0.15且昨日的PZ5小于0.15}

TP1 := HHV(HIGH, M); {M日最高价}
TP := HIGH = TP1; {今日最高价是M日最高价}


V2 AND PZ AND TP; {同时满足V2、PZ、TP三个条件};
```

![](https://gitee.com/shao818/Figure/raw/master/截图_20212131102151.png)

>不要在交易日的交易时间筛选，因为受当天数据限制，筛选结果可能为空。

## 成长性突破

```
{根据近两年营业收入与净利润增长率筛选}

{近两年营业收入和扣非净利润同比增长率大于5%且小于30%}

{近两年营业总收入}

INCOME1 := FINONE(183,Y-1,1231) > 5; {Y年年报净利润增速大于5%}
INCOME11 := FINONE(183,Y-1,1231) < 30; {Y年年报净利润增速小于30%,确保小幅增加}

INCOME2 := FINONE(183,Y-2,1231) > 5; {Y-1年年报净利润增速大于5%}
INCOME22 := FINONE(183,Y-2,1231) < 30; {Y-1年年报净利润增速小于30%}

{近两年扣非净利润}

PROFIT1 := FINONE(191,Y-1,1231) >5; {Y年年报净利润增速大于5%}
PROFIT11 := FINONE(191,Y-1,1231) < 30; {Y年年报净利润增速小于30%}

PROFIT2 := FINONE(191,Y-2,1231) >5; {Y-1年年报净利润增速大于5%}

PROFIT22 := FINONE(191,Y-2,1231) <30; {Y-1年年报净利润增速小于30%}

{最近一期季报：营业收入与扣非净利润均大于30%}

INCOME3 := FINONE(183,K,Z) > 30; {近期财报营业收入大于30，Z和K为0表示最近一期}
PROFIT3 := FINONE(191,K,Z) >30;  {近期财报扣非净利润增速大于30%，Z和K为0表示最近一期}


PROFIT4 :=FINONE(2,K,Z) >0;  {近期财报扣非每股收益大于零，Z和K为0表示最近一期}

INCOME1 AND INCOME11 AND  INCOME2 AND INCOME22 AND PROFIT1 AND PROFIT11 AND PROFIT2 AND PROFIT22 AND INCOME3 AND  PROFIT3 AND PROFIT4; {同时符合四个条件};
```

![](https://gitee.com/shao818/Figure/raw/master/截图_20213131103136.png)

## 收盘价创一年新高

```
{VOL1 :=V/REF(V,1)>Y;相对昨天放量1.5倍}

COL1 :=CLOSE=HHV(HIGH,D);{收盘价创新高}

COL1;
```

## 翻倍高成长

```
{动量因子：成交量翻倍}
VOL1 :=V/REF(V,1)>D;{相对上一周期成交量上涨50%}
{上涨幅度较前一周期翻倍}
COL1 :=(CLOSE/REF(CLOSE,1)-1)>ABS(REF(CLOSE,1)/REF(CLOSE,2)-1)*K;{本周期涨幅是上一周期涨幅的2倍}




{成长因子：最近一期季报营业收入与扣非净利润均大于30%}

INCOME3 := FINONE(183,Y,Z) > 30; {近期财报营业收入大于30%}
PROFIT3 := FINONE(191,Y,Z) >30;  {近期财报扣非净利润增速大于30%}


PROFIT4 :=FINONE(2,Y,Z) >0;  {近期财报扣非每股收益大于零}


VOL1 AND COL1 AND INCOME3 AND PROFIT3 AND PROFIT4;
```

## 口袋支点

```
{高开有缺口}
OPEN1 := OPEN>REF(CLOSE,1);
{涨停}
CLOSE1:= CLOSE>1.095*REF(CLOSE,1);


OPEN1 AND CLOSE1;
```

## 月线反转

```
{月线反转5.0版本的条件选股公式的源代码如下(建议无脑复制)：}
{条件1：50日RPS大于85}
Z:=EXTDATA_USER(3,0);{50天的}

RPS50:=Z/10;

D:=IF(RPS50<=85,0,1);{RPS50大于85}
{条件2：站上年线}

A:=C/MA(C,250)>1;{站上年线}

{条件3：一月内曾创50日新高}

NH:=IF(H<HHV(H,50),0,1);

B:=COUNT(NH,30);{一月内曾创50日新高}

{条件4：收盘价站上年线}

NN:=IF(C>MA(C,250),1,0);

AA:=COUNT(NN,30);

{条件5：最高价距离120日内的最高价不到10%}

AB:=HIGH/HHV(HIGH,120)>0.9;

A  AND  B  AND  D  AND  AA>2  AND  AA<30  AND  AB;{刚刚站上年线小于30天，大于2天的};
```

# 指标公式


## 主图指标：年线上下界

　　公式的效果是在一年的区间内，分别在最高价点位画一条虚线，在最低价点位画一条虚线



> 特别说明：因为这个是主图指标，所以下面的公式是直接加在你当前正在使用的的主图指标公式里面的，不是和之前副图指标一样新建技术指标公式，这个要注意一下。


```
{周期数}

MAXBARSCOUNT:=IF(TOTALBARSCOUNT>250,250,TOTALBARSCOUNT);



{250日最高价}

H250:DRAWLINE(CURRBARSCOUNT=MAXBARSCOUNT,CONST(HHV(H,MAXBARSCOUNT)),CURRBARSCOUNT=1,HHV(H,MAXBARSCOUNT),3)DOTLINE;



{250最低价}

L250:DRAWLINE(CURRBARSCOUNT=MAXBARSCOUNT,CONST(LLV(L,MAXBARSCOUNT)),CURRBARSCOUNT=1,LLV(L,MAXBARSCOUNT),3)DOTLINE;
```

## 副图指标：RPS指标  
 
 

### 第一步：建立指标计算年度个股涨幅

```
EXTRS:(C-REF(C,N))/REF(C,N);
```

![](https://gitee.com/shao818/Figure/raw/master/截图_20215531085534.png)


### 第二步:创建扩展数据

>扩展数据就是根据个股年度涨跌幅进行排名，并对排名按照0-10000作归一化处理,即涨幅最大的股票取值为1000，
这也是为什么创建RPS指标公式时将数据指标除以10的原因所在。


![](https://gitee.com/shao818/Figure/raw/master/截图_20215931085925.png)

>个人的几个扩展数据如下：

![](https://gitee.com/shao818/Figure/raw/master/截图_20215031095029.png)


### 第三步:创建个股RPS指标

此部分分为以下几点：

- 首先，引用刚刚创建的扩展数据，需要注意不同周期的RPS曲线与引用的数据要一致。

- 其次，绘制RPS虚线（请注意将对应扩展数据除以10，因为前边排名是0-1000的归一化处理）
，命令说明如下：

  - `:=`，表示赋值；

  - `EXTDATA_USER(5,0)`，表示引用序号为5的扩展数据；参数5表示扩展数据序号，参数0表示是当天的数据，如果是昨天的就取值为1,前天的就取值为2；
  -  `:`，表示输出，通常在创建技术指标时使用；

  - `LINETHICK2`，表示线宽；

  - `COLORGREEN`，表示线的颜色；

  - `IF(RPS10>=M,RPS10,DRAWNULL),LINETHICK2,COLORRED`，表示如果RPS10大于等于M则画红线，否则不划线。`DRAWNULL`返回无效函数。


```
W:=EXTDATA_USER(5,0);{10天的}
RPS10:W/10,LINETHICK2,COLORGREEN;
IF(RPS10>=M,RPS10,DRAWNULL),LINETHICK2,COLORRED;

U:=EXTDATA_USER(4,0);{20天的}
RPS20:U/10,LINETHICK2,COLORWHITE;
IF(RPS20>=M,RPS20,DRAWNULL),LINETHICK2,COLORRED;

Z:=EXTDATA_USER(3,0);{50天的}
RPS50:Z/10,LINETHICK2,COLORYELLOW;
IF(RPS50>=M,RPS50,DRAWNULL),LINETHICK2,COLORRED;

X:=EXTDATA_USER(1,0);{120天的}
RPS120:X/10,LINETHICK2,COLORLICYAN;
IF(RPS120>=M,RPS120,DRAWNULL),LINETHICK2,COLORRED;

Y:=EXTDATA_USER(2,0);{250天的}
RPS250:Y/10,LINETHICK2,COLORBROWN;
IF(RPS250>=M,RPS250,DRAWNULL),LINETHICK2,COLORRED;
```

![](https://gitee.com/shao818/Figure/raw/master/截图_20212131092147.png)


## 港资持股曲线指标

```
NOTEXT曲线:GPJYVALUE(6,1,1),COLORFFFF00;

IF((GPJYVALUE(6,1,1)/FINANCE(7))>0.01,NOTEXT曲线,DRAWNULL),LINETHICK1,COLORRED;

IF((GPJYVALUE(6,1,1)/FINANCE(7))=0,NOTEXT曲线,DRAWNULL),LINETHICK1,COLORWHITE;

IF((GPJYVALUE(6,1,1)/FINANCE(7))>0 AND (GPJYVALUE(6,1,1)/FINANCE(7))<0.01,NOTEXT曲线,DRAWNULL),LINETHICK1,COLORCYAN;

持股量:GPJYVALUE(6,1,1)/10000,COLORLIBLUE;

万股:DRAWNULL;

占流通比:(GPJYVALUE(6,1,1)/FINANCE(7))*100,NODRAW;

占总股比:(GPJYVALUE(6,1,1)/FINANCE(1))*100,NODRAW;

增减万股:(GPJYVALUE(6,1,1)-REF(GPJYVALUE(6,1,1),1))/10000;

增减:=GPJYVALUE(6,1,1)-REF(GPJYVALUE(6,1,1),1);

IF(增减<0,增减,DRAWNULL),STICK,LINETHICK4,COLORCYAN;

IF(增减=0,增减,DRAWNULL),STICK,LINETHICK4,COLORWHITE;

IF(增减>0,增减,DRAWNULL),STICK,LINETHICK4,COLORRED;

```

## 月线反转  　　

月线反转5.0版本的技术指标公式的几个条件是：  

- （1）日线收盘价站上年线；   
- （2）一月内曾创50日新高；   
- （3）50日的RPS大于85；   
- （4）收盘价站上年线的天数大于2，小于30；    
- （5）最高价距离120日内的最高价不到10%；   



```
{月线反转5.0版本的技术指标公式的源代码如下(建议无脑复制)}

{绘制移动平均线}
MA10:MA(CLOSE,10);

MA20:MA(CLOSE,20);

MA50:MA(CLOSE,50);

MA120:MA(CLOSE,120);

MA250:MA(CLOSE,250);

{制作月线反转标记}
{条件1：RPS大于85}

Z:=EXTDATA_USER(3,0);{50天的}

RPS50:=Z/10;

D:=IF(RPS50<=85,0,1);{RPS50大于85}

{条件2：站上年线}

A:=C/MA(C,250)>1;

{条件3：一月内曾创50日新高}

NH:=IF(H<HHV(H,50),0,1);

B:=COUNT(NH,30);

{条件4：选出刚刚站上年线小于30天，大于2天的}

NN:=IF(C>MA(C,250),1,0);

AA:=COUNT(NN,30);

{条件5：最高价距离120日内的最高价不到10%}

AB:=HIGH/HHV(HIGH,120)>0.9;

 

DRAWICON(BARSSINCEN((A AND B AND D AND  AA>2  AND AA<30 AND AB),30)=0,LOW,34);

```

>公式中最后一句话的意思是指30天内第一次满足月线反转的信号时，将在该日k线下方画表情34（一个黄色图标）。最后一句AND前后应该都有空格。
